# Phase 4: CRDT - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸš€ å¿«é€Ÿä½“éªŒ

### 1. è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
cd packages/04-crdt-fundamentals
pnpm test
```

ä½ å°†çœ‹åˆ°ï¼š
- âœ… 14 ä¸ª G-Counter æµ‹è¯•é€šè¿‡
- âœ… 11 ä¸ª PN-Counter æµ‹è¯•é€šè¿‡
- âœ… 19 ä¸ª RGA æµ‹è¯•é€šè¿‡

**æ€»è®¡ï¼š44 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼**

### 2. è¿è¡Œå‘½ä»¤è¡Œ Demo

```bash
pnpm demo
```

ä½ å°†çœ‹åˆ° 6 ä¸ª Demoï¼š
1. **G-Counter**ï¼šåªå¢è®¡æ•°å™¨çš„åŸºæœ¬æ“ä½œå’Œåˆå¹¶
2. **PN-Counter**ï¼šå¯å¢å¯å‡è®¡æ•°å™¨
3. **RGA åŸºç¡€**ï¼šæ–‡æœ¬ç¼–è¾‘çš„æ’å…¥å’Œåˆ é™¤
4. **RGA å¹¶å‘**ï¼šä¸¤ä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘çš„åœºæ™¯
5. **RGA å¤šç”¨æˆ·**ï¼šä¸‰ä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘å¹¶æ”¶æ•›
6. **RGA ç¦»çº¿**ï¼šç¦»çº¿ç¼–è¾‘ååŒæ­¥çš„åœºæ™¯

### 3. å¯åŠ¨äº¤äº’å¼ç½‘é¡µ Demo

```bash
pnpm dev
```

ç„¶åæ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:5176`

ä½ å°†çœ‹åˆ°ï¼š
- 3 ä¸ªå¹¶è¡Œçš„ç¼–è¾‘å™¨ï¼ˆAliceã€Bobã€Charlieï¼‰
- å®æ—¶æ“ä½œæ—¥å¿—
- 3 ä¸ªåœºæ™¯æµ‹è¯•æŒ‰é’®
- å†…éƒ¨çŠ¶æ€æŸ¥çœ‹åŠŸèƒ½

## ğŸ“š å­¦ä¹ è·¯å¾„

### ç¬¬ä¸€æ­¥ï¼šç†è§£æ¦‚å¿µï¼ˆ20åˆ†é’Ÿï¼‰

é˜…è¯» `docs/01-what-is-crdt.md`ï¼š
- âœ… CRDT æ˜¯ä»€ä¹ˆï¼Ÿ
- âœ… ä¸ºä»€ä¹ˆéœ€è¦ CRDTï¼Ÿ
- âœ… æ•°å­¦åŸºç¡€ï¼šäº¤æ¢å¾‹ã€ç»“åˆå¾‹ã€å¹‚ç­‰æ€§
- âœ… State-based vs Operation-based

**å…³é”®æ´å¯Ÿ**ï¼š
```
OT çš„æ€è·¯ï¼š"é‡åˆ°å†²çªï¼Œç”¨ç®—æ³•è§£å†³"
CRDT çš„æ€è·¯ï¼š"è®¾è®¡æ•°æ®ç»“æ„ï¼Œè®©å†²çªä¸å­˜åœ¨"
```

### ç¬¬äºŒæ­¥ï¼šå®ç° G-Counterï¼ˆ30åˆ†é’Ÿï¼‰

æŸ¥çœ‹ `src/g-counter.ts` å’Œ `src/g-counter.test.ts`

**æ ¸å¿ƒä»£ç **ï¼š
```typescript
// merge å‡½æ•°ï¼šå–æ¯ä¸ªå‰¯æœ¬çš„æœ€å¤§å€¼
merge(other: GCounter): GCounter {
  const result = new GCounter();
  const allReplicas = new Set([
    ...this.counts.keys(),
    ...other.counts.keys(),
  ]);
  for (const replica of allReplicas) {
    const thisCount = this.counts.get(replica) || 0;
    const otherCount = other.counts.get(replica) || 0;
    result.counts.set(replica, Math.max(thisCount, otherCount));
  }
  return result;
}
```

**è¿è¡Œæµ‹è¯•**ï¼š
```bash
pnpm test g-counter
```

### ç¬¬ä¸‰æ­¥ï¼šç†è§£ RGAï¼ˆ1å°æ—¶ï¼‰

æŸ¥çœ‹ `src/rga.ts` å’Œ `src/rga.test.ts`

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
1. æ¯ä¸ªå­—ç¬¦æœ‰å”¯ä¸€ IDï¼ˆreplicaId + clockï¼‰
2. åˆ é™¤ä½¿ç”¨å¢“ç¢‘æ ‡è®°ï¼ˆä¸çœŸæ­£åˆ é™¤ï¼‰
3. å¹¶å‘æ’å…¥é€šè¿‡ ID æ’åº

**å…³é”®ä»£ç **ï¼š
```typescript
// æ’å…¥æ—¶ç”Ÿæˆå”¯ä¸€ ID
const char: Character = {
  id: { replicaId: this.replicaId, clock: this.nextClock() },
  value,
  tombstone: false,
};

// å¹¶å‘æ’å…¥æ—¶æŒ‰ ID æ’åº
if (this.compareId(currentChar.id, char.id) < 0) {
  insertIndex++;
}
```

**è¿è¡Œæµ‹è¯•**ï¼š
```bash
pnpm test rga
```

### ç¬¬å››æ­¥ï¼šå¯¹æ¯” OT å’Œ CRDTï¼ˆ30åˆ†é’Ÿï¼‰

é˜…è¯» `docs/02-ot-vs-crdt.md`

**å…³é”®å¯¹æ¯”**ï¼š

| ç»´åº¦ | OT | CRDT |
|------|-----|------|
| æ¶æ„ | ä¸­å¿ƒåŒ– | å»ä¸­å¿ƒåŒ– |
| ç¦»çº¿ç¼–è¾‘ | å›°éš¾ | ç®€å• |
| æ•°æ®é‡ | å° | å¤§ |
| å®ç°å¤æ‚åº¦ | ç®—æ³•å¤æ‚ | æ•°æ®ç»“æ„å¤æ‚ |

**ä½•æ—¶ç”¨ CRDT**ï¼š
- âœ… ç¦»çº¿ç¼–è¾‘æ˜¯æ ¸å¿ƒéœ€æ±‚
- âœ… P2P åœºæ™¯
- âœ… å»ä¸­å¿ƒåŒ–æ¶æ„

**ä½•æ—¶ç”¨ OT**ï¼š
- âœ… æœ‰ç¨³å®šçš„æœåŠ¡å™¨
- âœ… å®æ—¶æ€§æ˜¯ç¬¬ä¸€ä¼˜å…ˆçº§
- âœ… ä¸»è¦æ˜¯åœ¨çº¿ååŒ

### ç¬¬äº”æ­¥ï¼šä½“éªŒäº¤äº’å¼ Demoï¼ˆ30åˆ†é’Ÿï¼‰

å¯åŠ¨ Demoï¼š
```bash
pnpm dev
```

**åœºæ™¯ 1ï¼šåŸºç¡€åŒæ­¥**
1. ç‚¹å‡»"åœºæ™¯1ï¼šåŸºç¡€åŒæ­¥"
2. è§‚å¯Ÿ Alice è¾“å…¥ "Hello"
3. è§‚å¯Ÿæ“ä½œå¦‚ä½•åŒæ­¥åˆ° Bob å’Œ Charlie

**åœºæ™¯ 2ï¼šå¹¶å‘æ’å…¥**
1. ç‚¹å‡»"åœºæ™¯2ï¼šå¹¶å‘æ’å…¥"
2. ä¸‰ä¸ªç”¨æˆ·åŒæ—¶åœ¨å¼€å¤´æ’å…¥ä¸åŒå­—ç¬¦
3. è§‚å¯Ÿå®ƒä»¬å¦‚ä½•è‡ªåŠ¨æ”¶æ•›åˆ°ç›¸åŒç»“æœ

**åœºæ™¯ 3ï¼šå†²çªè§£å†³**
1. ç‚¹å‡»"åœºæ™¯3ï¼šå†²çªè§£å†³"
2. Alice å’Œ Bob åŒæ—¶ç¼–è¾‘åŒä¸€æ–‡æ¡£
3. è§‚å¯Ÿ CRDT å¦‚ä½•è‡ªåŠ¨è§£å†³å†²çª

**æ‰‹åŠ¨æµ‹è¯•**ï¼š
1. åœ¨ Alice çš„ç¼–è¾‘å™¨è¾“å…¥æ–‡å­—
2. ç‚¹å‡»"åŒæ­¥æ‰€æœ‰å‰¯æœ¬"
3. è§‚å¯Ÿæ‰€æœ‰ç¼–è¾‘å™¨æ˜¯å¦æ”¶æ•›åˆ°ç›¸åŒå†…å®¹

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹

### 1. G-Counter çš„ç²¾é«“

```typescript
// ä¸ºä»€ä¹ˆå–æœ€å¤§å€¼ï¼Ÿ
result.counts.set(replica, Math.max(thisCount, otherCount));

åŸå› ï¼š
âœ… å¹‚ç­‰æ€§ï¼šé‡å¤åˆå¹¶ä¸ä¼šæ”¹å˜ç»“æœ
âœ… äº¤æ¢å¾‹ï¼šåˆå¹¶é¡ºåºæ— å…³
âœ… æ”¶æ•›æ€§ï¼šæœ€ç»ˆæ‰€æœ‰å‰¯æœ¬ç›¸åŒ
```

### 2. RGA çš„ç²¾é«“

```typescript
// ä¸ºä»€ä¹ˆéœ€è¦å”¯ä¸€ IDï¼Ÿ
const char: Character = {
  id: { replicaId: this.replicaId, clock: this.nextClock() },
  value,
  tombstone: false,
};

åŸå› ï¼š
âœ… ä½ç½®ä¼šå˜åŒ–ï¼Œä½† ID ä¸å˜
âœ… å¹¶å‘æ’å…¥å¯ä»¥é€šè¿‡ ID æ’åº
âœ… åˆ é™¤å¯ä»¥ç²¾ç¡®å®šä½å­—ç¬¦
âœ… æ”¯æŒç¦»çº¿ç¼–è¾‘
```

### 3. å¢“ç¢‘çš„å¿…è¦æ€§

```typescript
// ä¸ºä»€ä¹ˆåˆ é™¤ä¸çœŸæ­£åˆ é™¤ï¼Ÿ
delete(position: number): DeleteOperation | null {
  this.chars[index].tombstone = true; // æ ‡è®°ä¸ºåˆ é™¤
  // è€Œä¸æ˜¯ this.chars.splice(index, 1); // çœŸæ­£åˆ é™¤
}

åŸå› ï¼š
âœ… å› æœå…³ç³»ï¼šå…¶ä»–å‰¯æœ¬å¯èƒ½è¿˜åœ¨å¼•ç”¨è¿™ä¸ªå­—ç¬¦
âœ… å¹‚ç­‰æ€§ï¼šé‡å¤åˆ é™¤ä¸ä¼šæœ‰å‰¯ä½œç”¨
âœ… ç¦»çº¿æ”¯æŒï¼šç¦»çº¿å‰¯æœ¬éœ€è¦çŸ¥é“å“ªäº›å­—ç¬¦è¢«åˆ é™¤äº†
```

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: CRDT çš„æ•°æ®é‡å¤ªå¤§æ€ä¹ˆåŠï¼Ÿ

**A**: ç”Ÿäº§çº§ CRDTï¼ˆå¦‚ Yjsï¼‰ä½¿ç”¨äº†å¤šç§ä¼˜åŒ–æŠ€æœ¯ï¼š
- å¢é‡ç¼–ç ï¼ˆDelta encodingï¼‰
- å‹ç¼©ç®—æ³•
- åƒåœ¾å›æ”¶ï¼ˆæ¸…ç†å¢“ç¢‘ï¼‰
- æ ‘å½¢ç»“æ„ï¼ˆè€Œä¸æ˜¯æ•°ç»„ï¼‰

### Q2: ä¸ºä»€ä¹ˆæˆ‘çš„ Demo åœºæ™¯ 4 æ˜¾ç¤ºæ”¶æ•›å¤±è´¥ï¼Ÿ

**A**: è¿™æ˜¯å› ä¸ºç®€åŒ–å®ç°ä¸­çš„æ“ä½œåº”ç”¨é¡ºåºé—®é¢˜ã€‚åœ¨äº¤äº’å¼ Demo ä¸­æˆ‘ä»¬å·²ç»ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ã€‚è¿™ä¹Ÿè¯´æ˜äº†ä¸ºä»€ä¹ˆç”Ÿäº§çº§ CRDT éœ€è¦æ›´å¤æ‚çš„å®ç°ã€‚

### Q3: CRDT çœŸçš„èƒ½æ›¿ä»£ OT å—ï¼Ÿ

**A**: ä¸èƒ½å®Œå…¨æ›¿ä»£ï¼Œå„æœ‰ä¼˜åŠ¿ï¼š
- Google Docs ä»ç„¶ç”¨ OTï¼ˆå®æ—¶æ€§å¥½ï¼‰
- Figma ç”¨ CRDTï¼ˆè®¾è®¡å·¥å…·ï¼Œç¦»çº¿éœ€æ±‚ï¼‰
- æœ€ä½³å®è·µï¼šæ ¹æ®åœºæ™¯é€‰æ‹©æˆ–æ··åˆä½¿ç”¨

### Q4: å¦‚ä½•å­¦ä¹ æ›´é«˜çº§çš„ CRDTï¼Ÿ

**A**: æ¨èèµ„æºï¼š
1. [Yjs](https://github.com/yjs/yjs) - é«˜æ€§èƒ½ CRDT åº“
2. [Automerge](https://github.com/automerge/automerge) - JSON CRDT
3. [CRDT è®ºæ–‡](https://hal.inria.fr/inria-00555588/document)

## ğŸ“ ä¸‹ä¸€æ­¥

å®Œæˆ Phase 4 åï¼Œä½ å·²ç»æŒæ¡äº†ï¼š
- âœ… CRDT çš„æ ¸å¿ƒåŸç†
- âœ… State-based CRDTï¼ˆG-Counterã€PN-Counterï¼‰
- âœ… Operation-based CRDTï¼ˆRGAï¼‰
- âœ… OT vs CRDT çš„æƒè¡¡

**ç»§ç»­å­¦ä¹ **ï¼š
1. æ¢ç´¢ Yjs çš„ä¼˜åŒ–æŠ€æœ¯
2. å®ç°æ›´å¤æ‚çš„ CRDTï¼ˆå¦‚ JSON CRDTï¼‰
3. æ„å»ºä¸€ä¸ªå®Œæ•´çš„ååŒåº”ç”¨ï¼ˆPhase 5ï¼‰

## ğŸ’¡ å°è´´å£«

- ğŸ§ª **å®éªŒæ˜¯æœ€å¥½çš„è€å¸ˆ**ï¼šä¿®æ”¹ Demo ä»£ç ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆ
- ğŸ“ **é˜…è¯»æµ‹è¯•ç”¨ä¾‹**ï¼šæµ‹è¯•ç”¨ä¾‹æ˜¯æœ€å¥½çš„ä½¿ç”¨ç¤ºä¾‹
- ğŸ› **è°ƒè¯•æŠ€å·§**ï¼šä½¿ç”¨"æŸ¥çœ‹å†…éƒ¨çŠ¶æ€"æŒ‰é’®è§‚å¯Ÿ CRDT çš„å†…éƒ¨ç»“æ„
- ğŸ¨ **è‡ªå·±åŠ¨æ‰‹**ï¼šå°è¯•å®ç°ä¸€ä¸ª OR-Setï¼ˆå¯åˆ é™¤çš„é›†åˆï¼‰

---

**ç¥å­¦ä¹ æ„‰å¿«ï¼** ğŸš€

å¦‚æœæœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- `README.md` - é¡¹ç›®æ¦‚è§ˆ
- `docs/` - è¯¦ç»†æ–‡æ¡£
- `src/*.test.ts` - æµ‹è¯•ç”¨ä¾‹

