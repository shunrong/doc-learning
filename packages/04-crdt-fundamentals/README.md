# Phase 4: CRDT åŸºç¡€ - æ— å†²çªå¤åˆ¶æ•°æ®ç±»å‹

> **å­¦ä¹ ç›®æ ‡**ï¼šç†è§£ CRDT çš„æ ¸å¿ƒåŸç†ï¼ŒæŒæ¡å»ä¸­å¿ƒåŒ–ååŒç¼–è¾‘æ–¹æ¡ˆ

## ğŸ¯ æœ¬é˜¶æ®µå­¦ä¹ å†…å®¹

### 1. CRDT æ ¸å¿ƒæ¦‚å¿µ

- âœ… CRDT æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ
- âœ… ä¸ OT çš„æœ¬è´¨åŒºåˆ«
- âœ… æ•°å­¦åŸºç¡€ï¼šäº¤æ¢å¾‹ã€ç»“åˆå¾‹ã€å¹‚ç­‰æ€§
- âœ… State-based vs Operation-based CRDT

### 2. å®ç°çš„ CRDT æ•°æ®ç»“æ„

#### åŸºç¡€ CRDT
- **G-Counter**ï¼ˆGrow-only Counterï¼‰ï¼šåªå¢è®¡æ•°å™¨
  - æœ€ç®€å•çš„ CRDT
  - ç†è§£åˆå¹¶è§„åˆ™
  - ç†è§£æ”¶æ•›æ€§

- **PN-Counter**ï¼ˆPositive-Negative Counterï¼‰ï¼šå¯å¢å¯å‡è®¡æ•°å™¨
  - é€šè¿‡ä¸¤ä¸ª G-Counter å®ç°
  - å·§å¦™çš„å‡æ³•è½¬æ¢

#### é«˜çº§ CRDT
- **RGA**ï¼ˆReplicated Growable Arrayï¼‰ï¼šæ–‡æœ¬ç¼–è¾‘å™¨
  - åŸºäºå”¯ä¸€ ID çš„å­—ç¬¦å®šä½
  - å¢“ç¢‘æ ‡è®°ï¼ˆTombstoneï¼‰
  - å¹¶å‘æ’å…¥çš„å†²çªè§£å†³
  - ç¦»çº¿ç¼–è¾‘æ”¯æŒ

### 3. OT vs CRDT å¯¹æ¯”

è¯¦ç»†å¯¹æ¯”ä¸¤ç§æ–¹æ¡ˆçš„ï¼š
- æ¶æ„æ¨¡å¼ï¼ˆä¸­å¿ƒåŒ– vs å»ä¸­å¿ƒåŒ–ï¼‰
- å†²çªè§£å†³æœºåˆ¶
- ç¦»çº¿ç¼–è¾‘æ”¯æŒ
- æ€§èƒ½ç‰¹ç‚¹
- é€‚ç”¨åœºæ™¯

## ğŸ“ é¡¹ç›®ç»“æ„

```
04-crdt-fundamentals/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ 01-what-is-crdt.md         # CRDT æ ¸å¿ƒæ¦‚å¿µ
â”‚   â””â”€â”€ 02-ot-vs-crdt.md           # OT vs CRDT å¯¹æ¯”
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ g-counter.ts                # G-Counter å®ç°
â”‚   â”œâ”€â”€ g-counter.test.ts           # G-Counter æµ‹è¯•
â”‚   â”œâ”€â”€ pn-counter.ts               # PN-Counter å®ç°
â”‚   â”œâ”€â”€ pn-counter.test.ts          # PN-Counter æµ‹è¯•
â”‚   â”œâ”€â”€ rga.ts                      # RGA æ–‡æœ¬ç¼–è¾‘å™¨å®ç°
â”‚   â”œâ”€â”€ rga.test.ts                 # RGA æµ‹è¯•
â”‚   â””â”€â”€ main.ts                     # äº¤äº’å¼ Demo
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ crdt-demo.ts                # å‘½ä»¤è¡Œ Demo
â”œâ”€â”€ index.html                      # äº¤äº’å¼ç½‘é¡µ Demo
â””â”€â”€ README.md
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd packages/04-crdt-fundamentals
pnpm install
```

### 2. è¿è¡Œæµ‹è¯•

```bash
pnpm test
```

### 3. å¯åŠ¨äº¤äº’å¼ Demo

```bash
pnpm dev
```

ç„¶åæ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:5176`

### 4. è¿è¡Œå‘½ä»¤è¡Œ Demo

```bash
pnpm demo
```

## ğŸ’¡ å­¦ä¹ è·¯å¾„

### Step 1: ç†è§£ CRDT æ¦‚å¿µ

é˜…è¯» `docs/01-what-is-crdt.md`ï¼Œç†è§£ï¼š
- CRDT çš„å®šä¹‰å’Œæ ¸å¿ƒæ€æƒ³
- ä¸ºä»€ä¹ˆéœ€è¦ CRDTï¼ˆOT çš„å±€é™ï¼‰
- CRDT çš„æ•°å­¦åŸºç¡€
- State-based å’Œ Operation-based çš„åŒºåˆ«

### Step 2: å®ç° G-Counter

æŸ¥çœ‹ `src/g-counter.ts`ï¼Œç†è§£ï¼š
- æœ€ç®€å•çš„ CRDT æ˜¯å¦‚ä½•å·¥ä½œçš„
- `merge` å‡½æ•°å¦‚ä½•ä¿è¯æ”¶æ•›æ€§
- å¦‚ä½•æ»¡è¶³äº¤æ¢å¾‹ã€ç»“åˆå¾‹ã€å¹‚ç­‰æ€§

è¿è¡Œæµ‹è¯•ï¼š
```bash
pnpm test g-counter
```

### Step 3: å®ç° PN-Counter

æŸ¥çœ‹ `src/pn-counter.ts`ï¼Œç†è§£ï¼š
- å¦‚ä½•é€šè¿‡ä¸¤ä¸ª G-Counter å®ç°å‡æ³•
- ä¸ºä»€ä¹ˆè¿™ç§è®¾è®¡æ˜¯å·§å¦™çš„

### Step 4: å®ç° RGAï¼ˆæ ¸å¿ƒï¼‰

æŸ¥çœ‹ `src/rga.ts`ï¼Œç†è§£ï¼š
- å¦‚ä½•ç”¨å”¯ä¸€ ID æ ‡è¯†å­—ç¬¦
- å¢“ç¢‘æ ‡è®°çš„ä½œç”¨
- å¹¶å‘æ’å…¥å¦‚ä½•é€šè¿‡ ID æ’åºè§£å†³å†²çª
- ç¦»çº¿ç¼–è¾‘å¦‚ä½•å®ç°

è¿è¡Œæµ‹è¯•ï¼š
```bash
pnpm test rga
```

### Step 5: å¯¹æ¯” OT å’Œ CRDT

é˜…è¯» `docs/02-ot-vs-crdt.md`ï¼Œç†è§£ï¼š
- ä¸¤ç§æ–¹æ¡ˆçš„æœ¬è´¨åŒºåˆ«
- å„è‡ªçš„ä¼˜åŠ£åŠ¿
- å¦‚ä½•é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ

### Step 6: ä½“éªŒäº¤äº’å¼ Demo

è¿è¡Œ `pnpm dev`ï¼Œä½“éªŒï¼š
- åœºæ™¯ 1ï¼šåŸºç¡€åŒæ­¥
- åœºæ™¯ 2ï¼šå¹¶å‘æ’å…¥
- åœºæ™¯ 3ï¼šå†²çªè§£å†³

è§‚å¯Ÿï¼š
- æ“ä½œå¦‚ä½•ä¼ æ’­
- å‰¯æœ¬å¦‚ä½•æ”¶æ•›
- å†…éƒ¨çŠ¶æ€çš„å˜åŒ–

## ğŸ” æ ¸å¿ƒä»£ç è§£æ

### G-Counter çš„ merge å‡½æ•°

```typescript
merge(other: GCounter): GCounter {
  const result = new GCounter();
  
  // è·å–æ‰€æœ‰å‰¯æœ¬ID
  const allReplicas = new Set([
    ...this.counts.keys(),
    ...other.counts.keys(),
  ]);
  
  // å¯¹æ¯ä¸ªå‰¯æœ¬ï¼Œå–æœ€å¤§å€¼
  for (const replica of allReplicas) {
    const thisCount = this.counts.get(replica) || 0;
    const otherCount = other.counts.get(replica) || 0;
    result.counts.set(replica, Math.max(thisCount, otherCount));
  }
  
  return result;
}
```

**å…³é”®ç‚¹**ï¼š
- å–æœ€å¤§å€¼ä¿è¯äº†å¹‚ç­‰æ€§ï¼ˆé‡å¤åˆå¹¶ä¸ä¼šæ”¹å˜ç»“æœï¼‰
- å–æœ€å¤§å€¼ä¿è¯äº†äº¤æ¢å¾‹ï¼ˆåˆå¹¶é¡ºåºæ— å…³ï¼‰
- æ¯ä¸ªå‰¯æœ¬ç‹¬ç«‹è®¡æ•°ï¼Œé¿å…äº†å†²çª

### RGA çš„å¹¶å‘æ’å…¥å¤„ç†

```typescript
applyInsert(operation: InsertOperation): void {
  const { char, afterId } = operation;
  
  // æ‰¾åˆ° afterId çš„ä½ç½®
  let insertIndex = this.findIndex(afterId) + 1;
  
  // å¤„ç†å¹¶å‘æ’å…¥ï¼šæŒ‰ ID æ’åº
  while (insertIndex < this.chars.length) {
    if (this.compareId(this.chars[insertIndex].id, char.id) < 0) {
      insertIndex++;
    } else {
      break;
    }
  }
  
  this.chars.splice(insertIndex, 0, char);
}
```

**å…³é”®ç‚¹**ï¼š
- åŸºäº `afterId` è€Œä¸æ˜¯ä½ç½®ï¼ˆä½ç½®ä¼šå˜åŒ–ï¼‰
- å¹¶å‘æ’å…¥é€šè¿‡ ID æ’åºè§£å†³å†²çª
- æ— è®ºæ“ä½œé¡ºåºï¼Œæœ€ç»ˆç»“æœç›¸åŒ

## ğŸ“Š æµ‹è¯•è¦†ç›–

### G-Counter æµ‹è¯•
- âœ… åŸºç¡€é€’å¢
- âœ… åˆå¹¶æ“ä½œ
- âœ… äº¤æ¢å¾‹
- âœ… ç»“åˆå¾‹
- âœ… å¹‚ç­‰æ€§
- âœ… ååŒåœºæ™¯æ¨¡æ‹Ÿ

### RGA æµ‹è¯•
- âœ… åŸºç¡€æ’å…¥/åˆ é™¤
- âœ… å¢“ç¢‘æ ‡è®°
- âœ… å¹¶å‘æ’å…¥
- âœ… å¹¶å‘åˆ é™¤
- âœ… å¤æ‚ååŒåœºæ™¯
- âœ… ç¦»çº¿ç¼–è¾‘

è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼š
```bash
pnpm test
```

æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡ï¼š
```bash
pnpm test:coverage
```

## ğŸ“ å­¦ä¹ è¦ç‚¹

### ç†è§£ CRDT çš„æœ¬è´¨

```
OT çš„æ€è·¯ï¼š"é‡åˆ°å†²çªï¼Œç”¨ç®—æ³•è§£å†³"
CRDT çš„æ€è·¯ï¼š"è®¾è®¡æ•°æ®ç»“æ„ï¼Œè®©å†²çªä¸å­˜åœ¨"

ç±»æ¯”ï¼š
OT = äº‹åå¤„ç†ï¼ˆé‡åˆ°é—®é¢˜è§£å†³é—®é¢˜ï¼‰
CRDT = äº‹å‰é¢„é˜²ï¼ˆè®¾è®¡æ¶ˆé™¤é—®é¢˜ï¼‰
```

### ç†è§£å¢“ç¢‘çš„å¿…è¦æ€§

```
ä¸ºä»€ä¹ˆåˆ é™¤ä¸èƒ½çœŸæ­£åˆ é™¤ï¼Ÿ

1. å› æœå…³ç³»ï¼šå…¶ä»–å‰¯æœ¬å¯èƒ½è¿˜åœ¨å¼•ç”¨è¿™ä¸ªå­—ç¬¦
2. å¹‚ç­‰æ€§ï¼šé‡å¤åº”ç”¨åˆ é™¤æ“ä½œä¸ä¼šæœ‰å‰¯ä½œç”¨
3. ç¦»çº¿æ”¯æŒï¼šç¦»çº¿å‰¯æœ¬éœ€è¦çŸ¥é“å“ªäº›å­—ç¬¦è¢«åˆ é™¤äº†

ä»£ä»·ï¼š
- å†…å­˜å ç”¨å¢åŠ 
- éœ€è¦åƒåœ¾å›æ”¶æœºåˆ¶
```

### ç†è§£å”¯ä¸€ ID çš„ä½œç”¨

```
ä¸ºä»€ä¹ˆæ¯ä¸ªå­—ç¬¦éœ€è¦å”¯ä¸€ IDï¼Ÿ

1. ä½ç½®ä¼šå˜åŒ–ï¼Œä½† ID ä¸å˜
2. å¹¶å‘æ’å…¥å¯ä»¥é€šè¿‡ ID æ’åº
3. åˆ é™¤å¯ä»¥ç²¾ç¡®å®šä½å­—ç¬¦
4. æ”¯æŒç¦»çº¿ç¼–è¾‘

ID çš„è®¾è®¡ï¼š
{
  replicaId: string,  // å‰¯æœ¬æ ‡è¯†ï¼ˆä¿è¯ä¸åŒå‰¯æœ¬ä¸å†²çªï¼‰
  clock: number       // é€»è¾‘æ—¶é’Ÿï¼ˆä¿è¯åŒä¸€å‰¯æœ¬å†…å”¯ä¸€ï¼‰
}
```

## ğŸ†š ä¸ Phase 3 (OT) å¯¹æ¯”

| ç»´åº¦ | Phase 3 (OT) | Phase 4 (CRDT) |
|------|--------------|----------------|
| **æ¶æ„** | ä¸­å¿ƒåŒ– | å»ä¸­å¿ƒåŒ– |
| **æ ¸å¿ƒç®—æ³•** | Transform | æ•°æ®ç»“æ„ + Merge |
| **ç¦»çº¿ç¼–è¾‘** | å¤æ‚ | ç®€å• |
| **æ•°æ®é‡** | å° | å¤§ |
| **é€‚ç”¨åœºæ™¯** | å®æ—¶ååŒ | ç¦»çº¿ä¼˜å…ˆ |

## ğŸ”— ç›¸å…³èµ„æº

### è®ºæ–‡
- [A comprehensive study of CRDT](https://hal.inria.fr/inria-00555588/document)
- [RGA: Replicated Growable Array](https://pages.lip6.fr/Marc.Shapiro/papers/RR-8083.pdf)

### å¼€æºé¡¹ç›®
- [Yjs](https://github.com/yjs/yjs) - é«˜æ€§èƒ½ CRDT åº“
- [Automerge](https://github.com/automerge/automerge) - CRDT æ•°æ®ç»“æ„åº“
- [ShareDB](https://github.com/share/sharedb) - OT å®ç°ï¼ˆå¯¹æ¯”å­¦ä¹ ï¼‰

### ç›¸å…³äº§å“
- Figmaï¼ˆè®¾è®¡ååŒï¼‰
- Notionï¼ˆç¬”è®°ï¼‰
- Apple Notesï¼ˆiCloud åŒæ­¥ï¼‰

## ğŸ¯ ä¸‹ä¸€æ­¥å­¦ä¹ 

å®Œæˆ Phase 4 åï¼Œä½ å¯ä»¥ï¼š

1. **æ·±å…¥ CRDT ä¼˜åŒ–**
   - å­¦ä¹  Yjs çš„ä¼˜åŒ–æŠ€æœ¯
   - å®ç°åƒåœ¾å›æ”¶æœºåˆ¶
   - ä¼˜åŒ–å†…å­˜å’Œæ€§èƒ½

2. **æ¢ç´¢æ··åˆæ–¹æ¡ˆ**
   - ä½•æ—¶ç”¨ OTï¼Œä½•æ—¶ç”¨ CRDT
   - å¦‚ä½•åœ¨ä¸€ä¸ªäº§å“ä¸­åŒæ—¶ä½¿ç”¨

3. **å®æˆ˜é¡¹ç›®**
   - å®ç°ä¸€ä¸ªæ”¯æŒç¦»çº¿çš„ç¬”è®°åº”ç”¨
   - å®ç°ä¸€ä¸ª P2P æ–‡æ¡£ç¼–è¾‘å™¨

4. **ç»§ç»­ Phase 5**
   - å­¦ä¹ çœŸå®çš„ç¼–è¾‘å™¨æ¡†æ¶ï¼ˆQuill.js / Slate.jsï¼‰
   - é›†æˆ CRDT/OT åˆ°å®é™…é¡¹ç›®

---

**æ­å–œï¼** ğŸ‰ ä½ å·²ç»æŒæ¡äº†ååŒç¼–è¾‘çš„ä¸¤å¤§æ ¸å¿ƒç®—æ³•ï¼ˆOT + CRDTï¼‰ï¼Œå…·å¤‡äº†æ„å»ºååŒåº”ç”¨çš„ç†è®ºåŸºç¡€ï¼

