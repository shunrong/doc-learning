# Phase 3: Operational Transformation (OT) - ååŒç¼–è¾‘æ ¸å¿ƒç®—æ³•

> æ·±å…¥ç†è§£ååŒç¼–è¾‘çš„ç»å…¸æ–¹æ¡ˆï¼ŒæŒæ¡ Google Docsã€Quill.js èƒŒåçš„æ ¸å¿ƒæŠ€æœ¯

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡è¿™ä¸ªé˜¶æ®µï¼Œä½ å°†ï¼š

1. âœ… **ç†è§£ååŒç¼–è¾‘çš„æ ¸å¿ƒæŒ‘æˆ˜**
   - å¹¶å‘å†²çªçš„æœ¬è´¨
   - ä¸ºä»€ä¹ˆéœ€è¦ Transform
   - æ”¶æ•›æ€§çš„æ•°å­¦å®šä¹‰

2. ğŸ”¨ **å®ç° OT æ ¸å¿ƒç®—æ³•**ï¼ˆå½“å‰è¿›åº¦ 80%ï¼‰
   - Transform å‡½æ•°çš„ 9 ç§ç»„åˆ
   - TP1 æ€§è´¨éªŒè¯
   - è¾¹ç•Œæƒ…å†µå¤„ç†

3. ğŸ“¡ **æ„å»ºå®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹**
   - å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†
   - æœåŠ¡å™¨æ“ä½œæ’åº
   - ç¡®è®¤æœºåˆ¶ï¼ˆACKï¼‰

4. ğŸ® **åˆ›å»ºå®æ—¶ååŒ Demo**
   - WebSocket å®æ—¶é€šä¿¡
   - å¤šç”¨æˆ·åŒæ—¶ç¼–è¾‘
   - æ“ä½œå†å²å¯è§†åŒ–

5. ğŸ” **å¯¹æ¯” OT å’Œ CRDT**
   - å„è‡ªçš„ä¼˜åŠ£
   - é€‚ç”¨åœºæ™¯
   - ä¸ºä»€ä¹ˆä¸¤è€…éƒ½é‡è¦

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µ

### 1. Transformï¼šOT çš„çµé­‚

```typescript
// åœºæ™¯ï¼šä¸¤ä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘ "ABC"
const doc = "ABC";
const aliceOp = [insert("X")];           // Alice: â†’ "XABC"
const bobOp   = [retain(2), insert("Y")]; // Bob: â†’ "ABYC"

// é—®é¢˜ï¼šæœ€ç»ˆåº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ
// ç­”æ¡ˆï¼šç”¨ Transform ä¿è¯åŒæ–¹æ”¶æ•›åˆ° "XABYC"

// Alice ç«¯
const bobOp_transformed = transform(bobOp, aliceOp, "right");
// [retain(3), insert("Y")] - ä½ç½®ä» 2 è°ƒæ•´åˆ° 3

// Bob ç«¯
const aliceOp_transformed = transform(aliceOp, bobOp, "left");
// [insert("X")] - ä¸éœ€è¦è°ƒæ•´

// ç»“æœï¼šåŒæ–¹éƒ½æ˜¯ "XABYC" âœ“
```

### 2. Transform vs Compose

| ç»´åº¦ | Compose | Transform |
|------|---------|-----------|
| **è¾“å…¥** | é¡ºåºæ“ä½œ | å¹¶å‘æ“ä½œ |
| **åŸºå‡†æ–‡æ¡£** | op2 åŸºäº apply(doc, op1) | éƒ½åŸºäº doc |
| **ç›®çš„** | å†å²å‹ç¼© | å†²çªè§£å†³ |
| **åœºæ™¯** | æ’¤é”€/é‡åš | ååŒç¼–è¾‘ |

**å…³é”®ç†è§£**ï¼š
- **Compose** = è§†é¢‘å‰ªè¾‘ï¼ˆåˆå¹¶é•œå¤´ï¼‰
- **Transform** = äº¤é€šè·¯å£ï¼ˆé¿å…ç¢°æ’ï¼‰

### 3. TP1 æ€§è´¨ï¼ˆæ”¶æ•›æ€§ä¿è¯ï¼‰

```typescript
// ä¸¤æ¡è·¯å¾„å¿…é¡»åˆ°è¾¾åŒä¸€ç»“æœ
apply(apply(doc, op1), transform(op2, op1, "right")) ===
apply(apply(doc, op2), transform(op1, op2, "left"))
```

è¿™æ˜¯ OT æ­£ç¡®æ€§çš„æ•°å­¦ä¿è¯ï¼

## ğŸ“ é¡¹ç›®ç»“æ„

```
03-operational-transformation/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types.ts                 # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ operation.ts             # åŸºç¡€æ“ä½œï¼ˆapplyï¼‰
â”‚   â”œâ”€â”€ transform.ts             # Transform æ ¸å¿ƒå®ç° â­
â”‚   â”œâ”€â”€ transform.test.ts        # Transform æµ‹è¯•ï¼ˆ17 ä¸ªç”¨ä¾‹ï¼‰
â”‚   â”œâ”€â”€ client.ts                # å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â”œâ”€â”€ index.ts             # WebSocket æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ ot-server.ts         # OT æœåŠ¡å™¨é€»è¾‘
â”‚   â””â”€â”€ main.ts                  # å‰ç«¯ Demo
â”‚
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ 01-what-is-ot.md         # OT æ˜¯ä»€ä¹ˆï¼Ÿ
â”‚   â”œâ”€â”€ 02-transform-vs-compose.md  # Transform vs Compose
â”‚   â”œâ”€â”€ 03-why-learn-ot.md       # ä¸ºä»€ä¹ˆå­¦ OTï¼Ÿ
â”‚   â””â”€â”€ 04-client-server-model.md   # å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹
â”‚
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ ot-demo.ts               # Transform æ¼”ç¤ºè„šæœ¬
â”‚
â”œâ”€â”€ index.html                   # å®æ—¶ååŒ Demo
â””â”€â”€ README.md                    # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. è¿è¡Œæµ‹è¯•

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
cd packages/03-operational-transformation

# è¿è¡Œå•å…ƒæµ‹è¯•
pnpm test

# å½“å‰æµ‹è¯•ç»“æœï¼š
# âœ… 13 ä¸ªæµ‹è¯•é€šè¿‡ï¼ˆInsert vs Delete, Delete vs Delete ç­‰ï¼‰
# ğŸ”¨ 4 ä¸ªæµ‹è¯•å¾…å®Œå–„ï¼ˆInsert vs Insert çš„ side å‚æ•°å¤„ç†ï¼‰
```

### 2. è¿è¡Œ Transform æ¼”ç¤º

```bash
pnpm demo

# è¾“å‡ºç¤ºä¾‹ï¼š
# - å±•ç¤ºå„ç§ Transform åœºæ™¯
# - éªŒè¯ TP1 æ€§è´¨
# - å¯¹æ¯”ä¸åŒçš„å¹¶å‘å†²çª
```

### 3. å¯åŠ¨å®æ—¶ååŒ Demoï¼ˆå¼€å‘ä¸­ï¼‰

```bash
# å¯åŠ¨æœåŠ¡å™¨
pnpm server

# å¯åŠ¨å‰ç«¯
pnpm dev

# è®¿é—® http://localhost:5175
# - æ‰“å¼€å¤šä¸ªæµè§ˆå™¨æ ‡ç­¾
# - åŒæ—¶ç¼–è¾‘æ–‡æ¡£
# - è§‚å¯Ÿå®æ—¶åŒæ­¥æ•ˆæœ
```

## ğŸ“– å­¦ä¹ è·¯å¾„

### Step 1: ç†è§£æ ¸å¿ƒæ¦‚å¿µ âœ…

1. é˜…è¯» `docs/01-what-is-ot.md`
   - OT è§£å†³ä»€ä¹ˆé—®é¢˜
   - Transform å‡½æ•°çš„ä½œç”¨
   - TP1/TP2 æ€§è´¨

2. é˜…è¯» `docs/02-transform-vs-compose.md`
   - Transform å’Œ Compose çš„æœ¬è´¨åŒºåˆ«
   - å„è‡ªçš„åº”ç”¨åœºæ™¯
   - ä¸ºä»€ä¹ˆå®¹æ˜“æ··æ·†

3. é˜…è¯» `docs/03-why-learn-ot.md`
   - ä¸ºä»€ä¹ˆ OT ä»ç„¶é‡è¦
   - OT vs CRDT å¯¹æ¯”
   - çœŸå®äº§å“çš„é€‰æ‹©

### Step 2: å®ç° Transform å‡½æ•° ğŸ”¨ï¼ˆå½“å‰è¿›åº¦ 80%ï¼‰

**å·²å®Œæˆ**ï¼š
- âœ… Insert vs Deleteï¼ˆæ’å…¥ä¸å—åˆ é™¤å½±å“ï¼‰
- âœ… Delete vs Deleteï¼ˆè®¡ç®—é‡å éƒ¨åˆ†ï¼‰
- âœ… Retain vs Deleteï¼ˆè°ƒæ•´ä¿ç•™ä½ç½®ï¼‰
- âœ… å¤§éƒ¨åˆ†å¤æ‚åœºæ™¯

**å¾…å®Œå–„**ï¼š
- ğŸ”¨ Insert vs Insert çš„ side å‚æ•°å¤„ç†
  - åŒä½ç½®æ’å…¥çš„é¡ºåºå†³å®š
  - ç©ºæ–‡æ¡£çš„å¹¶å‘æ’å…¥
  - è¿™æ˜¯ OT ä¸­æœ€å¾®å¦™çš„éƒ¨åˆ†

**å­¦ä¹ å»ºè®®**ï¼š
- å½“å‰ 80% çš„å®ç°è¶³ä»¥ç†è§£ OT çš„æ ¸å¿ƒæ€æƒ³
- å‰©ä½™ 20% æ˜¯è¾¹ç•Œæƒ…å†µï¼Œä¸å½±å“æ•´ä½“ç†è§£
- å¯ä»¥å…ˆç»§ç»­å­¦ä¹ å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹
- å›å¤´å†å®Œå–„ç»†èŠ‚

### Step 3: å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹ ğŸ“¡ï¼ˆæ¥ä¸‹æ¥ï¼‰

ç†è§£ååŒç¼–è¾‘çš„å®Œæ•´æµç¨‹ï¼š

```
å®¢æˆ·ç«¯ A                æœåŠ¡å™¨              å®¢æˆ·ç«¯ B
   |                     |                    |
   | â‘  æœ¬åœ°ç¼–è¾‘          |                    |
   |    "ABC" â†’ "XABC"   |                    |
   |                     |                    |
   | â‘¡ å‘é€æ“ä½œ          |                    |
   |------ op1 --------->|                    |
   |                     | â‘¢ åº”ç”¨ + æ’åº     |
   |                     |    version++       |
   |                     |                    |
   |                     | â‘£ å¹¿æ’­             |
   |<------ op1 ---------|------- op1 ------>|
   |                     |                    | â‘¤ åº”ç”¨
   |                     |                    |    "ABC" â†’ "XABC"
```

**æ ¸å¿ƒæŒ‘æˆ˜**ï¼š
- æ“ä½œæ’åºï¼ˆä¸­å¤®æœåŠ¡å™¨çš„ä½œç”¨ï¼‰
- æœªç¡®è®¤æ“ä½œçš„ç®¡ç†
- ç½‘ç»œå»¶è¿Ÿå’Œä¸¢åŒ…å¤„ç†

### Step 4: å®æ—¶ååŒ Demo ğŸ®ï¼ˆæ ¸å¿ƒç›®æ ‡ï¼‰

æ„å»ºä¸€ä¸ªå¯ä»¥å¤šäººåŒæ—¶ç¼–è¾‘çš„æ–‡æœ¬ç¼–è¾‘å™¨ï¼š

**åŠŸèƒ½**ï¼š
- å¤šä¸ªç”¨æˆ·åŒæ—¶ç¼–è¾‘
- å®æ—¶çœ‹åˆ°ä»–äººçš„ä¿®æ”¹
- å…‰æ ‡ä½ç½®åŒæ­¥
- æ“ä½œå†å²å±•ç¤º
- ç½‘ç»œçŠ¶æ€æç¤º

**æŠ€æœ¯æ ˆ**ï¼š
- WebSocketï¼ˆå®æ—¶é€šä¿¡ï¼‰
- TypeScriptï¼ˆç±»å‹å®‰å…¨ï¼‰
- åŸç”Ÿ DOMï¼ˆä¿æŒç®€æ´ï¼‰

### Step 5: æ‹“å±•ä¸å¯¹æ¯” ğŸ”

**å¯¹æ¯” OT å’Œ CRDT**ï¼š
- OT: ç®—æ³•è½¬æ¢ï¼ˆéœ€è¦æœåŠ¡å™¨æ’åºï¼‰
- CRDT: æ•°æ®ç»“æ„ï¼ˆæ•°å­¦ä¿è¯æ”¶æ•›ï¼‰

**çœŸå®æ¡ˆä¾‹**ï¼š
- Google Docs: OT
- Figma: CRDT
- Notion: OT + CRDT æ··åˆ

**ä¸ºä»€ä¹ˆä¸¤è€…éƒ½é‡è¦**ï¼š
- ä¸åŒåœºæ™¯é€‚åˆä¸åŒæ–¹æ¡ˆ
- ç†è§£æƒè¡¡ï¼ˆTrade-offï¼‰
- å±•ç¤ºæŠ€æœ¯å¹¿åº¦

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹è§£è¯»

### Transform çš„ 9 ç§æ ¸å¿ƒç»„åˆ

| op1 \ op2 | Insert | Delete | Retain |
|-----------|--------|--------|--------|
| **Insert** | âœ… 13/17 | âœ… å®Œæˆ | âœ… å®Œæˆ |
| **Delete** | âœ… å®Œæˆ | âœ… å®Œæˆ | âœ… å®Œæˆ |
| **Retain** | âœ… å®Œæˆ | âœ… å®Œæˆ | âœ… å®Œæˆ |

### å…¸å‹æµ‹è¯•æ¡ˆä¾‹

```typescript
// æµ‹è¯• 1: Insert vs Delete
doc = "ABCDE"
op1 = [retain(2), insert("X")]  // åœ¨ä½ç½® 2 æ’å…¥ X
op2 = [retain(1), deleteOp(2)]  // åˆ é™¤ BC

// æœŸæœ›ï¼šTransform ååŒæ–¹éƒ½æ˜¯ "AXDE"
// âœ… æµ‹è¯•é€šè¿‡

// æµ‹è¯• 2: Delete vs Delete (é‡å )
doc = "ABCDE"
op1 = [retain(1), deleteOp(2)]  // åˆ é™¤ BC
op2 = [retain(2), deleteOp(2)]  // åˆ é™¤ CD

// æœŸæœ›ï¼šTransform ååŒæ–¹éƒ½æ˜¯ "AE"
// âœ… æµ‹è¯•é€šè¿‡

// æµ‹è¯• 3: Insert vs Insert (åŒä½ç½®)
doc = "ABC"
op1 = [retain(1), insert("X")]  // åœ¨ä½ç½® 1 æ’å…¥ X
op2 = [retain(1), insert("Y")]  // åœ¨ä½ç½® 1 æ’å…¥ Y

// æœŸæœ›ï¼šside å‚æ•°å†³å®šé¡ºåºï¼Œæœ€ç»ˆéƒ½æ˜¯ "AXYBC"
// ğŸ”¨ å¾…å®Œå–„ï¼ˆå½“å‰éƒ¨åˆ†ç”¨ä¾‹ä¸é€šè¿‡ï¼‰
```

## ğŸ’¡ å…³é”®æ´å¯Ÿ

### 1. Transform æ˜¯ OT çš„æ ¸å¿ƒï¼Œä½†ä¸æ˜¯å…¨éƒ¨

```
å®Œæ•´çš„ååŒç¼–è¾‘ç³»ç»Ÿ = 
  Transformï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰
  + å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†
  + æœåŠ¡å™¨æ“ä½œæ’åº
  + ç½‘ç»œé€šä¿¡åè®®
  + UI äº¤äº’è®¾è®¡
```

### 2. OT çš„éš¾ç‚¹ä¸åœ¨ç†è®ºï¼Œåœ¨å®ç°

- ç†è®ºï¼ˆTP1ï¼‰ï¼šå¾ˆå®¹æ˜“ç†è§£
- å®ç°ï¼ˆTransformï¼‰ï¼šè¾¹ç•Œæƒ…å†µå¾ˆå¤š
- å·¥ç¨‹ï¼ˆå®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼‰ï¼šçŠ¶æ€ç®¡ç†å¤æ‚

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ CRDT è¶Šæ¥è¶Šæµè¡Œ**ï¼š
- CRDTï¼šç†è®ºå¤æ‚ï¼Œå®ç°ç®€å•ï¼ˆæ•°æ®ç»“æ„ä¿è¯æ”¶æ•›ï¼‰
- OTï¼šç†è®ºç®€å•ï¼Œå®ç°å¤æ‚ï¼ˆéœ€è¦æ­£ç¡®çš„ Transformï¼‰

### 3. å­¦ä¹ ç­–ç•¥ï¼šç†è§£æœ¬è´¨ > å®Œç¾å®ç°

```
ç›®æ ‡ä¼˜å…ˆçº§ï¼š
  1. âœ… ç†è§£å¹¶å‘å†²çªçš„æœ¬è´¨
  2. âœ… ç†è§£ Transform çš„ä½œç”¨
  3. âœ… å®ç° 80% çš„ Transformï¼ˆä¸»æµåœºæ™¯ï¼‰
  4. ğŸ¯ æ„å»ºå®æ—¶ååŒ Demoï¼ˆæ•´ä½“ç†è§£ï¼‰
  5. ğŸ”¨ å®Œå–„ Transform ç»†èŠ‚ï¼ˆå¦‚æœ‰æ—¶é—´ï¼‰
```

## ğŸ“ å­¦ä¹ æˆæœ

å®Œæˆ Phase 3 åï¼Œä½ å°†èƒ½å¤Ÿï¼š

1. âœ… **è§£é‡ŠååŒç¼–è¾‘çš„åŸç†**
   - å‘é¢è¯•å®˜æ¸…æ™°è®²è§£ OT
   - å¯¹æ¯” OT å’Œ CRDT çš„ä¼˜åŠ£
   - ç†è§£ Google Docs çš„æŠ€æœ¯æ¶æ„

2. âœ… **å®ç°ç®€å•çš„ååŒç¼–è¾‘å™¨**
   - åŸºäº WebSocket çš„å®æ—¶åŒæ­¥
   - åŸºæœ¬çš„å†²çªè§£å†³
   - å¤šç”¨æˆ·ç¼–è¾‘ä½“éªŒ

3. âœ… **è¯„ä¼°æŠ€æœ¯æ–¹æ¡ˆ**
   - ä½•æ—¶é€‰æ‹© OT
   - ä½•æ—¶é€‰æ‹© CRDT
   - å¦‚ä½•æƒè¡¡æ€§èƒ½å’Œå¤æ‚åº¦

4. âœ… **å±•ç¤ºç³»ç»Ÿè®¾è®¡èƒ½åŠ›**
   - å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„
   - çŠ¶æ€ç®¡ç†
   - å®æ—¶é€šä¿¡

## ğŸ“š æ¨èèµ„æº

### è®ºæ–‡å’Œæ–‡ç« 
- [Operational Transformation (Wikipedia)](https://en.wikipedia.org/wiki/Operational_transformation)
- [Google Wave OT è®ºæ–‡](https://svn.apache.org/repos/asf/incubator/wave/whitepapers/operational-transform/operational-transform.html)
- [Understanding OT (Gentle Introduction)](https://operational-transformation.github.io/)

### å¼€æºå®ç°
- [Quill Delta](https://github.com/quilljs/delta) - Quill.js çš„ OT å®ç°
- [ShareDB](https://github.com/share/sharedb) - æˆç†Ÿçš„ OT æ¡†æ¶
- [ot.js](https://github.com/Operational-Transformation/ot.js) - çº¯ JS OT åº“

### å¯¹æ¯” CRDT
- [CRDT.tech](https://crdt.tech/) - CRDT èµ„æºæ±‡æ€»
- [Yjs](https://github.com/yjs/yjs) - æµè¡Œçš„ CRDT å®ç°
- [Automerge](https://github.com/automerge/automerge) - Notion ä½¿ç”¨çš„ CRDT

## ğŸš¦ å½“å‰è¿›åº¦

```
Phase 3 è¿›åº¦ï¼š60% å®Œæˆ
â”œâ”€â”€ âœ… æ ¸å¿ƒæ¦‚å¿µç†è§£
â”œâ”€â”€ ğŸ”¨ Transform å®ç°ï¼ˆ80%ï¼‰
â”œâ”€â”€ â³ å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹
â”œâ”€â”€ â³ å®æ—¶ååŒ Demo
â””â”€â”€ â³ OT vs CRDT å¯¹æ¯”
```

## ğŸ¯ ä¸‹ä¸€æ­¥

**ç»§ç»­ Phase 3**ï¼š
1. å®ç°å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†
2. å®ç° WebSocket æœåŠ¡å™¨
3. æ„å»ºå®æ—¶ååŒ Demo
4. å®Œå–„ Transform ç»†èŠ‚ï¼ˆå¯é€‰ï¼‰

**æˆ–è€…å…ˆç†è§£å…¨è²Œ**ï¼š
- æŸ¥çœ‹ Phase 4ï¼ˆCRDTï¼‰çš„è§„åˆ’
- äº†è§£å®Œæ•´çš„å­¦ä¹ è·¯å¾„
- æ ¹æ®å…´è¶£è°ƒæ•´é¡ºåº

---

**å‡†å¤‡å¥½ç»§ç»­äº†å—ï¼Ÿ** æˆ‘ä»¬å¯ä»¥å¼€å§‹å®ç°å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¨¡å‹å’Œå®æ—¶ Demoï¼ğŸš€

