# Phase 2: æ–‡æ¡£æ•°æ®ç»“æ„ä¸æ“ä½œ

> æ·±å…¥ç†è§£ Operation æ¨¡å‹ã€apply/invert/compose æ–¹æ³•ã€æ‰å¹³åŒ– vs æ ‘å½¢ç»“æ„

## ğŸ“– å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬é˜¶æ®µçš„å­¦ä¹ ï¼Œä½ å°†ï¼š

- âœ… æŒæ¡ **Operation æ¨¡å‹**çš„è®¾è®¡åŸç†ï¼ˆinsert/delete/retainï¼‰
- âœ… å®ç° **applyã€invertã€compose** ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•
- âœ… ç†è§£**æ‰å¹³åŒ–**å’Œ**æ ‘å½¢**ä¸¤ç§æ•°æ®æ¨¡å‹çš„å·®å¼‚
- âœ… ä¸º Phase 5ï¼ˆOTï¼‰å’Œ Phase 6ï¼ˆCRDTï¼‰æ‰“ä¸‹åŸºç¡€
- âœ… å­¦ä¼šä½¿ç”¨ **TypeScript** å’Œ **Vitest** è¿›è¡Œç®—æ³•å¼€å‘

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–
```bash
cd packages/02-document-model-operations
pnpm install
```

### è¿è¡Œå¼€å‘æœåŠ¡å™¨
```bash
pnpm dev
```

ç„¶åè®¿é—® http://localhost:5174

### è¿è¡Œæµ‹è¯•
```bash
pnpm test        # è¿è¡Œæµ‹è¯•
pnpm test:ui     # æµ‹è¯• UI ç•Œé¢
pnpm test:coverage  # æµ‹è¯•è¦†ç›–ç‡
```

## ğŸ¯ Demo è¯´æ˜

### Demo 1: Apply - åº”ç”¨æ“ä½œ
å±•ç¤ºå¦‚ä½•å°†æ“ä½œåºåˆ—åº”ç”¨åˆ°æ–‡æœ¬ä¸Šï¼Œç”Ÿæˆæ–°æ–‡æœ¬ã€‚

**æ ¸å¿ƒä»£ç ï¼š**
```typescript
const text = "Hello World";
const ops = [
  { type: 'retain', length: 6 },
  { type: 'delete', length: 5 },
  { type: 'insert', text: 'TypeScript' }
];
const result = apply(text, ops);
// result === "Hello TypeScript"
```

### Demo 2: Invert - ç”Ÿæˆåå‘æ“ä½œ
å±•ç¤ºå¦‚ä½•ç”Ÿæˆæ“ä½œçš„åå‘æ“ä½œï¼Œç”¨äºå®ç°æ’¤é”€åŠŸèƒ½ã€‚

**æ ¸å¿ƒä»£ç ï¼š**
```typescript
const text = "Hello";
const ops = [retain(5), insert(" World")];
const inverse = invert(ops, text);
// inverse === [retain(5), deleteOp(6)]

// éªŒè¯ï¼š
apply(apply(text, ops), inverse) === text  // true
```

### Demo 3: Compose - ç»„åˆæ“ä½œ
å±•ç¤ºå¦‚ä½•å°†å¤šä¸ªæ“ä½œç»„åˆæˆä¸€ä¸ªï¼Œç”¨äºå‹ç¼©å†å²è®°å½•ã€‚

**æ ¸å¿ƒä»£ç ï¼š**
```typescript
const ops1 = [insert("Hello")];
const ops2 = [retain(5), insert(" World")];
const composed = compose(ops1, ops2);
// composed === [insert("Hello World")]

// éªŒè¯ï¼š
apply(apply(text, ops1), ops2) === apply(text, composed)  // true
```

### Demo 4: æ•°æ®æ¨¡å‹å¯¹æ¯”
å¯¹æ¯”æ‰å¹³åŒ–ï¼ˆDeltaï¼‰å’Œæ ‘å½¢ï¼ˆSlateï¼‰ä¸¤ç§æ•°æ®æ¨¡å‹ã€‚

**æ‰å¹³åŒ–æ¨¡å‹ï¼ˆQuill Deltaï¼‰ï¼š**
```json
{
  "ops": [
    { "insert": "Hello ", "attributes": { "bold": true } },
    { "insert": "World\n" }
  ]
}
```

**æ ‘å½¢æ¨¡å‹ï¼ˆSlateï¼‰ï¼š**
```json
{
  "type": "document",
  "children": [
    {
      "type": "paragraph",
      "children": [
        { "type": "text", "text": "Hello ", "bold": true },
        { "type": "text", "text": "World" }
      ]
    }
  ]
}
```

### Demo 5: å¯è§†åŒ–æ‰§è¡Œæµç¨‹
é€æ­¥å¯è§†åŒ–å±•ç¤ºæ“ä½œçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¸®åŠ©ç†è§£æ¯ä¸€æ­¥çš„å˜åŒ–ã€‚

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µ

### 1. Operation çš„ä¸‰ç§ç±»å‹

#### Insertï¼ˆæ’å…¥ï¼‰
```typescript
{ type: 'insert', text: 'Hello', attributes?: { bold: true } }
```
åœ¨å½“å‰ä½ç½®æ’å…¥æ–‡æœ¬ï¼Œå¯é€‰åœ°åº”ç”¨æ ¼å¼ã€‚

#### Deleteï¼ˆåˆ é™¤ï¼‰
```typescript
{ type: 'delete', length: 5 }
```
åˆ é™¤æŒ‡å®šæ•°é‡çš„å­—ç¬¦ã€‚

#### Retainï¼ˆä¿ç•™ï¼‰
```typescript
{ type: 'retain', length: 10, attributes?: { bold: true } }
```
ä¿ç•™ï¼ˆè·³è¿‡ï¼‰æŒ‡å®šæ•°é‡çš„å­—ç¬¦ï¼Œå¯é€‰åœ°åº”ç”¨æˆ–ç§»é™¤æ ¼å¼ã€‚

### 2. ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•

#### apply(text, ops)
å°†æ“ä½œåºåˆ—åº”ç”¨åˆ°æ–‡æœ¬ä¸Šã€‚

**ç®—æ³•ï¼š**
1. éå†æ“ä½œåºåˆ—
2. Insertï¼šæ’å…¥æ–‡æœ¬
3. Deleteï¼šè·³è¿‡æŒ‡å®šé•¿åº¦
4. Retainï¼šå¤åˆ¶æŒ‡å®šé•¿åº¦çš„æ–‡æœ¬

#### invert(ops, originalText)
ç”Ÿæˆåå‘æ“ä½œï¼ˆç”¨äºæ’¤é”€ï¼‰ã€‚

**æ˜ å°„å…³ç³»ï¼š**
- Insert â†’ Delete
- Delete â†’ Insertï¼ˆæ’å…¥è¢«åˆ é™¤çš„æ–‡æœ¬ï¼‰
- Retain â†’ Retain

#### compose(ops1, ops2)
ç»„åˆä¸¤ä¸ªæ“ä½œåºåˆ—ã€‚

**æ•°å­¦æ€§è´¨ï¼š**
```typescript
apply(apply(text, ops1), ops2) === apply(text, compose(ops1, ops2))
```

### 3. æ•°æ®æ¨¡å‹å¯¹æ¯”

| ç»´åº¦ | æ‰å¹³åŒ–ï¼ˆDeltaï¼‰ | æ ‘å½¢ï¼ˆSlateï¼‰ |
|------|----------------|--------------|
| **ç»“æ„** | çº¿æ€§ã€ç®€å• | åµŒå¥—ã€å¤æ‚ |
| **é€‚ç”¨åœºæ™¯** | çº¿æ€§æ–‡æœ¬ | å¤æ‚æ–‡æ¡£ |
| **ååŒç¼–è¾‘** | å®¹æ˜“ï¼ˆOTï¼‰ | è¾ƒéš¾ |
| **è‡ªå®šä¹‰èŠ‚ç‚¹** | æœ‰é™ | çµæ´» |
| **ç±»å‹çº¦æŸ** | å¼± | å¼ºï¼ˆSchemaï¼‰ |

## ğŸ§ª æµ‹è¯•è¦†ç›–

å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹è¦†ç›–ï¼š

- âœ… apply çš„å„ç§åœºæ™¯
- âœ… invert çš„æ­£ç¡®æ€§éªŒè¯
- âœ… compose çš„æ•°å­¦æ€§è´¨
- âœ… è¾¹ç•Œæƒ…å†µå¤„ç†
- âœ… ä¸­æ–‡å’Œ Emoji æ”¯æŒ

è¿è¡Œæµ‹è¯•æŸ¥çœ‹è¯¦æƒ…ï¼š
```bash
pnpm test:coverage
```

## ğŸ“– ç†è®ºæ–‡æ¡£

é˜…è¯»é¡ºåºå»ºè®®ï¼š

1. [Operation æ¨¡å‹è®¾è®¡](./docs/01-operation-model.md)
   - Operation çš„è®¾è®¡ç†å¿µ
   - ä¸‰ç§æ“ä½œç±»å‹è¯¦è§£
   - ä¸ºä»€ä¹ˆéœ€è¦ Retainï¼Ÿ

2. [æ ¸å¿ƒæ–¹æ³•å®ç°](./docs/02-core-methods.md)
   - apply çš„å®ç°ç»†èŠ‚
   - invert çš„æ•°å­¦æ¨å¯¼
   - compose çš„ç®—æ³•åˆ†æ

3. [æ‰å¹³åŒ– vs æ ‘å½¢ç»“æ„](./docs/03-flat-vs-tree.md)
   - ä¸¤ç§æ¨¡å‹çš„å¯¹æ¯”
   - é€‚ç”¨åœºæ™¯åˆ†æ
   - å¦‚ä½•é€‰æ‹©ï¼Ÿ

4. [ä¸ºååŒç¼–è¾‘é“ºè·¯](./docs/04-prepare-for-ot.md)
   - Operation ä¸ OT çš„å…³ç³»
   - Transform å‡½æ•°é¢„è§ˆ
   - ä¸‹ä¸€æ­¥å­¦ä¹ æ–¹å‘

## ğŸ’¡ å­¦ä¹ å»ºè®®

### Day 1-2: ç†è§£ Operation
1. è¿è¡Œ Demo 1ï¼Œè§‚å¯Ÿ apply çš„æ‰§è¡Œ
2. é˜…è¯» `src/operation.ts` çš„ä»£ç 
3. ç†è§£ä¸‰ç§æ“ä½œç±»å‹çš„å«ä¹‰
4. æ€è€ƒï¼šä¸ºä»€ä¹ˆéœ€è¦ Retainï¼Ÿ

### Day 3-4: æ·±å…¥ç®—æ³•
1. é˜…è¯» `docs/02-core-methods.md`
2. ç ”ç©¶ invert å’Œ compose çš„å®ç°
3. è¿è¡Œæµ‹è¯•ï¼Œç†è§£æ¯ä¸ªç”¨ä¾‹
4. å°è¯•æ‰‹å†™ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ apply

### Day 5-6: æ•°æ®æ¨¡å‹å¯¹æ¯”
1. è¿è¡Œ Demo 4ï¼Œå¯¹æ¯”ä¸¤ç§æ¨¡å‹
2. é˜…è¯» `docs/03-flat-vs-tree.md`
3. æ€è€ƒï¼šå“ªç§æ¨¡å‹æ›´é€‚åˆååŒç¼–è¾‘ï¼Ÿ
4. å°è¯•ç”¨æ ‘å½¢ç»“æ„è¡¨ç¤ºå¤æ‚æ–‡æ¡£

### Day 7: æ€»ç»“ä¸å±•æœ›
1. æ•´ç†å­¦ä¹ ç¬”è®°
2. é˜…è¯» `docs/04-prepare-for-ot.md`
3. æ€è€ƒï¼šå¦‚ä½•å¤„ç†å¹¶å‘ç¼–è¾‘ï¼Ÿ
4. ä¸º Phase 5ï¼ˆOTï¼‰åšå‡†å¤‡

## ğŸ”‘ å…³é”®æ´å¯Ÿ

### 1. Operation æ˜¯ååŒç¼–è¾‘çš„åŸºç¡€
æ‰€æœ‰ååŒç¼–è¾‘ç®—æ³•ï¼ˆOTã€CRDTï¼‰éƒ½å»ºç«‹åœ¨ Operation ä¹‹ä¸Šã€‚

### 2. ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•çš„é‡è¦æ€§
- **apply**ï¼šç¼–è¾‘å™¨çš„æ ¸å¿ƒåŠŸèƒ½
- **invert**ï¼šæ’¤é”€é‡åšçš„åŸºç¡€
- **compose**ï¼šæ€§èƒ½ä¼˜åŒ–çš„å…³é”®

### 3. æ•°æ®ç»“æ„çš„é€‰æ‹©å½±å“ä¸€åˆ‡
- æ‰å¹³åŒ– â†’ ç®€å•ã€æ˜“äºååŒï¼ˆPhase 5 OTï¼‰
- æ ‘å½¢ â†’ å¼ºå¤§ã€é€‚åˆå¤æ‚åœºæ™¯ï¼ˆPhase 6 CRDTï¼‰

### 4. TypeScript çš„ä»·å€¼
Operation çš„ç±»å‹å®šä¹‰ç¡®ä¿äº†ç®—æ³•çš„æ­£ç¡®æ€§ã€‚

## ğŸ“ æ€è€ƒé¢˜

### 1. ä¸ºä»€ä¹ˆéœ€è¦ Retain æ“ä½œï¼Ÿ
<details>
<summary>æŸ¥çœ‹ç­”æ¡ˆ</summary>

å¦‚æœåªæœ‰ Insert å’Œ Deleteï¼Œæ— æ³•æè¿°"åœ¨æ–‡æ¡£ä¸­é—´æ’å…¥"çš„æ“ä½œã€‚

ä¾‹å¦‚ï¼Œè¦åœ¨ "Hello World" çš„ä¸­é—´æ’å…¥ "Beautiful "ï¼š
- âŒ ä¸è¡Œï¼š`[insert("Beautiful ")]` - ä¼šæ’å…¥åˆ°å¼€å¤´
- âœ… éœ€è¦ï¼š`[retain(6), insert("Beautiful ")]` - è·³è¿‡ "Hello "ï¼Œå†æ’å…¥

Retain ç”¨äºå®šä½æ“ä½œçš„ä½ç½®ã€‚
</details>

### 2. invert å’Œ undo æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
<details>
<summary>æŸ¥çœ‹ç­”æ¡ˆ</summary>

- **invert**ï¼šç”Ÿæˆåå‘æ“ä½œï¼ˆç®—æ³•å±‚é¢ï¼‰
- **undo**ï¼šæ’¤é”€ç”¨æˆ·æ“ä½œï¼ˆåº”ç”¨å±‚é¢ï¼‰

Undo éœ€è¦ï¼š
1. è®°å½•æ“ä½œå†å²
2. è°ƒç”¨ invert ç”Ÿæˆåå‘æ“ä½œ
3. åº”ç”¨åå‘æ“ä½œ

invert åªæ˜¯ undo çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ã€‚
</details>

### 3. compose çš„åº”ç”¨åœºæ™¯ï¼Ÿ
<details>
<summary>æŸ¥çœ‹ç­”æ¡ˆ</summary>

1. **å‹ç¼©å†å²è®°å½•**ï¼šç”¨æˆ·è¿ç»­è¾“å…¥ "H" "e" "l" "l" "o"ï¼Œå¯ä»¥ç»„åˆæˆä¸€ä¸ªæ“ä½œ
2. **ç¦»çº¿ç¼–è¾‘**ï¼šç§¯ç´¯å¤šä¸ªæ“ä½œï¼Œä¸Šçº¿åä¸€æ¬¡æ€§åŒæ­¥
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘æ“ä½œæ•°é‡ï¼Œæå‡åº”ç”¨æ€§èƒ½

compose æ˜¯ä¼˜åŒ–çš„å…³é”®ï¼
</details>

### 4. æ‰å¹³åŒ–å’Œæ ‘å½¢ç»“æ„å„é€‚åˆä»€ä¹ˆåœºæ™¯ï¼Ÿ
<details>
<summary>æŸ¥çœ‹ç­”æ¡ˆ</summary>

**æ‰å¹³åŒ–ï¼ˆDeltaï¼‰é€‚åˆï¼š**
- çº¿æ€§æ–‡æœ¬ç¼–è¾‘
- ååŒç¼–è¾‘ï¼ˆOT ç®—æ³•ï¼‰
- ç®€å•çš„å¯Œæ–‡æœ¬éœ€æ±‚

**æ ‘å½¢ç»“æ„é€‚åˆï¼š**
- å¤æ‚çš„åµŒå¥—ç»“æ„ï¼ˆè¡¨æ ¼ã€åˆ—è¡¨ï¼‰
- è‡ªå®šä¹‰èŠ‚ç‚¹ç±»å‹
- éœ€è¦ Schema çº¦æŸ

Google Docs ç”¨æ‰å¹³åŒ–ï¼ŒNotion ç”¨æ ‘å½¢ã€‚
</details>

## â­ï¸ ä¸‹ä¸€æ­¥

å®Œæˆæœ¬é˜¶æ®µåï¼Œä½ å¯ä»¥ï¼š

### é€‰æ‹© 1ï¼šç»§ç»­æ·±å…¥ï¼ˆPhase 3ï¼‰
å­¦ä¹ å†å²è®°å½•ä¸æ’¤é”€é‡åšï¼Œå®è·µ invert çš„åº”ç”¨ã€‚

### é€‰æ‹© 2ï¼šè·³åˆ°å®æˆ˜ï¼ˆPhase 4ï¼‰
å­¦ä¹  WebSocket å®æ—¶é€šä¿¡ï¼Œä¸ºååŒç¼–è¾‘æ‰“åŸºç¡€ã€‚

### é€‰æ‹© 3ï¼šç›´æ¥ååŒï¼ˆPhase 6ï¼‰
ä½¿ç”¨ Yjs å¿«é€Ÿå®ç°ååŒç¼–è¾‘ï¼ˆè·³è¿‡ç†è®ºï¼‰ã€‚

**æ¨èï¼š** æŒ‰é¡ºåºå­¦ä¹  Phase 3 â†’ Phase 4ï¼Œç†è§£å®Œæ•´ä½“ç³»ã€‚

## ğŸ”— ç›¸å…³èµ„æº

### ä»£ç ç¤ºä¾‹
- `src/operation.ts` - Operation æ ¸å¿ƒå®ç°
- `src/delta.ts` - Delta æ¨¡å‹å®ç°
- `src/tree.ts` - æ ‘å½¢æ¨¡å‹å®ç°
- `src/operation.test.ts` - å®Œæ•´æµ‹è¯•ç”¨ä¾‹

### æ–‡æ¡£
- `docs/` - ç†è®ºæ–‡æ¡£
- æ ¹ç›®å½• `docs/tech-comparison.md` - æŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”

### å‚è€ƒ
- [Quill Delta](https://quilljs.com/docs/delta/)
- [Slate Data Model](https://docs.slatejs.org/concepts/02-nodes)

---

**å¼€å§‹å­¦ä¹ ï¼š** è¿è¡Œ `pnpm dev`ï¼Œæ‰“å¼€æµè§ˆå™¨æ¢ç´¢ 5 ä¸ª Demoï¼ğŸš€

